{
 "variables": {
  "client_id": "{{env `ARM_CLIENT_ID`}}",
  "client_secret": "{{env `ARM_CLIENT_SECRET`}}",
  "resource_group": "{{env `ARM_RESOURCE_GROUP`}}",
  "storage_account": "{{env `ARM_STORAGE_ACCOUNT`}}",
  "subscription_id": "{{env `ARM_SUBSCRIPTION_ID`}}",
  "tenant_id": "{{env `ARM_TENANT_ID`}}",
  "ssh_user": "centos",
  "ssh_pass": null
 },
 "builders": [{
  "type": "azure-arm",

  "client_id": "{{user `client_id`}}",
  "client_secret": "{{user `client_secret`}}",
  "resource_group_name": "{{user `resource_group`}}",
  "storage_account": "{{user `storage_account`}}",
  "subscription_id": "{{user `subscription_id`}}",
  "tenant_id": "{{user `tenant_id`}}",

  "capture_container_name": "images",
  "capture_name_prefix": "packer",

  "ssh_username": "{{user `ssh_user`}}",
  "ssh_password": "{{user `ssh_pass`}}",

  "os_type": "Linux",
  "image_publisher": "RedHat",
  "image_offer": "RHEL",
  "image_sku": "7.3",
  "image_version": "latest",
  "ssh_pty": "true",

  "location": "South Central US",
  "vm_size": "Standard_DS2_v2"
 }],
 "provisioners": [{
   "execute_command": "echo '{{user `ssh_pass`}}' | {{ .Vars }} sudo -S -E sh '{{ .Path }}'",
   "inline": [
    "yum update -y",
    "/usr/sbin/waagent -force -deprovision+user && export HISTSIZE=0 && sync"
   ],
   "inline_shebang": "/bin/sh -x",
   "type": "shell",
   "skip_clean": true
  },
  {
   "type": "file",
   "override": {
    "azure-arm": {
     "destination": "/tmp/",
     "source": "./root"
    }
   }
  },
  {
   "type": "shell",
   "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
   "override": {
    "azure-arm": {
     "inline": [
      "/usr/bin/whoami",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=0/g' /etc/yum/pluginconf.d/rhui-lb.conf",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=0/g' /etc/yum.repos.d/redhat-rhui.repo",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=0/g' /etc/yum.repos.d/redhat-rhui-client-config.repo",
      "/usr/bin/sed -i -e 's/^enabled=0/enabled=1/g' /etc/yum/pluginconf.d/product-id.conf",
      "/usr/bin/sed -i -e 's/^enabled=0/enabled=1/g' /etc/yum/pluginconf.d/subscription-manager.conf",
      "/usr/bin/printf '%s\n' '209.132.183.44  xmlrpc.rhn.redhat.com' >> /etc/hosts",
      "/usr/bin/printf '%s\n' '23.204.148.218  content-xmlrpc.rhn.redhat.com' >> /etc/hosts",
      "/usr/bin/printf '%s\n' '209.132.183.49  subscription.rhn.redhat.com' >> /etc/hosts",
      "/usr/bin/printf '%s\n' '209.132.183.108 subscription.rhsm.redhat.com' >> /etc/hosts",
      "/usr/bin/printf '%s\n' '209.132.182.63  registry.access.redhat.com' >> /etc/hosts",
      "/usr/bin/printf '%s\n' '209.132.182.33  repository.jboss.org' >> /etc/hosts",
      "/usr/bin/rpmkeys --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-beta /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release",
      "if [ ! -z \"{{user `rhsm_username`}}\"  ] && [ ! -z \"{{user `rhsm_password`}}\" ]; then /usr/bin/subscription-manager register --username={{user `rhsm_username`}} --password={{user `rhsm_password`}} --auto-attach; fi",
      "if [ ! -z \"{{user `rhsm_org_id`}}\"  ] && [ ! -z \"{{user `rhsm_key_id`}}\" ]; then /usr/bin/subscription-manager register --org={{user `rhsm_org_id` }} --activationkey={{user `rhsm_key_id` }}; fi",
      "count=0; while [ $? -ne 0 ] || (( count++ >= 5 )); do !!; /usr/bin/sleep $count; done",
      "/usr/bin/subscription-manager refresh",
      "if [ ! -z \"{{user `rhsm_pool`}}\"  ]; then /usr/bin/subscription-manager subscribe --pool={{user `rhsm_pool` }}; fi"
     ]
    }
   }
  },
  {
   "type": "shell",
   "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
   "override": {
    "azure-arm": {
     "inline": [
      "/usr/bin/subscription-manager repos --disable=\"*\"",
      "/usr/bin/yum-config-manager --disable \\*",
      "/usr/bin/subscription-manager repos --enable=rhel-7-server-rpms --enable=rhel-7-server-extras-rpms",
      "INSTALL_PKGS='bash-completion bind-utils bridge-utils findutils gettext git httpd-tools iptables-services kexec-tools net-tools psacct sos tar unzip wget yum-utils'",
      "/usr/bin/yum install -y --setopt=tsflags=nodocs $INSTALL_PKGS",
      "/usr/bin/rpm -V $INSTALL_PKGS",
      "/usr/bin/yum clean all -y",
      "/usr/bin/rm -rf /var/cache/yum/*",
      "/usr/bin/yum update -y",
      "/usr/bin/systemctl reboot"
     ]
    }
   },
   "expect_disconnect": true
  },
  {
   "type": "shell",
   "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
   "override": {
    "azure-arm": {
     "inline": [
      "/usr/bin/subscription-manager remove --all",
      "/usr/bin/subscription-manager unregister",
      "/usr/bin/subscription-manager clean",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=1/g' /etc/yum/pluginconf.d/rhui-lb.conf",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=1/g' /etc/yum.repos.d/redhat-rhui.repo",
      "/usr/bin/sed -i -e 's/^enabled=1/enabled=1/g' /etc/yum.repos.d/redhat-rhui-client-config.repo",
      "/usr/bin/sed -i -e 's/^enabled=0/enabled=0/g' /etc/yum/pluginconf.d/product-id.conf",
      "/usr/bin/sed -i -e 's/^enabled=0/enabled=0/g' /etc/yum/pluginconf.d/subscription-manager.conf"
     ]
    }
   },
   "pause_before": "10s"
  }
 ]
}
